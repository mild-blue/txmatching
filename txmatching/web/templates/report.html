{% macro yes_no(value) %}
{% if value %}
<strong>Yes</strong>
{% else %}
No
{% endif %}
{% endmacro %}

{% macro donor_antigen_class(code, transplant) %}
{% if code in transplant.recipient.hla_antibodies.hla_antibodies_list %}
{# donor antigen matches some recipient antibody #}
bad-matching
{% elif code in transplant.recipient.parameters.hla_typing.codes_per_group %}
{# donor antigen matches some recipient antigen #}
matching
{% endif %}
{% endmacro %}

{% macro recipient_antigen_class(code, transplant) %}
{% if code in transplant.donor.parameters.hla_typing.codes_per_group
and code not in transplant.recipient.hla_antibodies.hla_antibodies_list %}
{# recipient antigen matches some donor antigen
and code is not recipient antibody #}
matching
{% endif %}
{% endmacro %}

{% macro recipient_antibody_class(code, transplant) %}
{% if code in transplant.donor.parameters.hla_typing.codes_per_group %}
{# recipient antibody matches some donor antigen #}
bad-matching
{% endif %}
{% endmacro %}

<html>
<head>
    <title>{{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap"
          rel="stylesheet">
</head>
<style>

    /* General */
    html, body {
        margin: 0;
        padding: 0;
    }

    body {
        font-size: 13px;
        font-family: 'Open Sans', sans-serif;
        font-weight: 300;
        background: #f8f9fa;
        color: #000;
    }

    h1 {
        margin-top: 0;
    }

    h3 {
        text-transform: uppercase;
        margin-top: 0;
    }

    h4 {
        margin: 0;
    }

    ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    strong {
        font-weight: 700;
    }

    /* Header */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;

        margin-bottom: 20px;

        /* wkhtmltopdf */
        display: -webkit-box;
        -webkit-box-pack: justify;
        -webkit-box-align: center;
    }

    .header h1 {
        margin: 0;
        color: {{ color }};
        font-size: 32px;
    }

    /* Logo */
    .logo {
        display: flex;
        justify-content: center;
        align-items: center;

        /* wkhtmltopdf */
        display: -webkit-box;
        -webkit-box-pack: center;
        -webkit-box-align: center;
    }

    .logo img {
        height: 50px;
    }

    .logo h2 {
        margin: 0 0 0 20px;
        padding-left: 20px;
        color: {{ color }};
        line-height: 1;
        font-size: 18px;
        position: relative;
    }

    .logo h2::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 3px;
        height: 100%;
        background: {{ color }};
    }

    /* Date */
    .date {
        font-weight: 700;
    }

    .date span {
        font-weight: 400;
        font-family: monospace;
        margin-left: 10px;
    }

    /* Box */
    .box {
        padding: 30px;
    }

    .box:nth-child(even) {
        background: #ffffff;
    }

    /* Configuration */
    .configuration ul li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 25px;

        /* wkhtmltopdf */
        display: -webkit-box;
        -webkit-box-pack: justify;
        -webkit-box-align: center;
    }

    .configuration ul li:not(:last-child) {
        border-bottom: 1px solid #dddddd;
    }

    .configuration .label {
        width: 50%;
    }

    .configuration .value {
        width: 50%;
        text-align: right;
    }

    /* Matching */
    .matching-header {
        padding-top: 30px;
        page-break-inside: avoid !important;
    }

    .matching-info {
        width: 100%;
        display: flex;
        margin-bottom: 10px;

        /* wkhtmltopdf */
        display: -webkit-box;
    }

    .matching-info li:last-child {
        -webkit-box-flex: 1;
    }

    .matching-info li:not(:last-child) {
        padding-right: 5px;
    }

    .matching-info li:not(:last-child)::after {
        content: '|';
        margin: 0 5px 0 10px;
        color: #454545;
    }

    /* Matching round */
    .matching-round {
        margin-bottom: 20px;
    }

    /* Matching transplant */
    .matching-transplant {
        border-top: none;
        border-radius: 40px;
        padding-top: 20px;
    }

    .matching-transplant, .matching-transplant > * {
        page-break-inside: avoid !important;
    }

    .transplant-header {
        background: #eff3f7;
        border: 1px solid #dddddd;
        border-bottom: none;
        padding: 0 10px;
        font-weight: 700;
        font-size: 14px;
        height: 50px;

        display: flex;
        justify-content: space-between;
        align-items: center;

        /* wkhtmltopdf */
        display: -webkit-box;
        -webkit-box-pack: justify;
        -webkit-box-align: center;
    }

    .transplant-header .score span {
        font-size: 18px;
        font-weight: 700;
        color: #e2001a;
    }

    /* Transplant table */

    .small {
        display: inline-block;
        margin-left: 5px;
    }

    .small, .small * {
        font-size: 8px !important;
    }

    .center-holder {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;

        /* wkhtmltopdf */
        display: -webkit-box;
        -webkit-box-pack: center;
        -webkit-box-align: center;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    tr {
        border-top: 1px solid #dddddd;
    }

    tr:first-child {
        font-weight: 700;
    }

    tr.anti-header td {
        background: #eff3f7;
        font-size: 12px;
        padding: 2px;
    }

    td {
        text-align: center;
        padding: 7px 10px;
        border: 1px solid #dddddd;
        vertical-align: top;

        width: auto;
    }

    td:not([colspan]) {
        width: 21.6666%;
    }

    td:first-child {
        width: 20%;
        text-align: left;
        font-weight: 700;
    }

    td:last-child {
        width: 15%;
        font-weight: 700;
    }

    .footer-score td {
        text-align: right;
    }

    .footer-score td:not(:last-child) {
        border: none !important;
    }

    .footer-score td:last-child {
        background: transparent;
    }

    .footer-score span {
        font-size: 18px;
        font-weight: 700;
        color: #e2001a;
    }

    /* Code */
    .code {
        display: inline-block;
        border-radius: 3px;
        padding: 3px 3px 1px;
        margin: 1px;

        background: #e9ecef;
        color: #6c757d;

        font-weight: 600;
        font-size: 12px;
    }

    .code.matching {
        background: rgba(40, 167, 69, 0.2);
        border-color: #28a745;
        color: #28a745;
    }

    .code.bad-matching {
        background: rgba(220, 53, 69, 0.2);
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }

    /* Patient */
    .patient {
        display: flex;
        align-items: center;
        font-weight: 700;

        /* wkhtmltopdf */
        display: -webkit-box;
        -webkit-box-align: center;
    }

    .patient .flag {
        margin-right: 5px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        border: 1px solid #ddd;

        /* wkhtmltopdf */
        display: -webkit-box;
        -webkit-box-pack: start;
        -webkit-box-align: center;
    }

    .patient img {
        height: 16px;
        width: 16px;
    }

    /* Helper classes */
    .mb-0 {
        margin-bottom: 0 !important;
    }

    .pt-0 {
        padding-top: 0 !important;
    }

    .color-primary {
        color: {{ color }} !important;
    }

</style>
<body>
<div class="box">
    <div class="header">
        <h1>{{ title }}</h1>

        <div class="logo">
            <img alt="logo" src="{{ logo }}"/>
            <h2>
                Transplant<br>Matching
            </h2>
        </div>
    </div>

    <div class="date">
        Generated
        <span>{{ date }}</span>
    </div>
</div>
<div class="box">
    <div class="configuration">
        <h1>Configuration</h1>
        <ul>
            <li>
                <div class="label">Require compatible blood group</div>
                <div class="value">{{ yes_no(configuration.require_compatible_blood_group) }}</div>
            </li>
            <li>
                <div class="label">Require new donor having better CI match than original donor</div>
                <div class="value">{{ yes_no(configuration.require_better_match_in_compatibility_index) }}</div>
            </li>
            <li>
                <div class="label">Require new donor having better CI match than original donor or blood group match
                </div>
                <div class="value">{{ yes_no(configuration.require_better_match_in_compatibility_index_or_blood_group)
                    }}
                </div>
            </li>
            <li>
                <div class="label">Use binary scoring</div>
                <div class="value">{{ yes_no(configuration.use_binary_scoring) }}</div>
            </li>
            <li>
                <div class="label">Use split resolution</div>
                <div class="value">{{ yes_no(configuration.use_split_resolution) }}</div>
            </li>
            <li>
                <div class="label">Minimum transplant score</div>
                <div class="value"><strong>{{ configuration.minimum_total_score }}</strong></div>
            </li>
            <li>
                <div class="label">Max countries in round</div>
                <div class="value"><strong>{{ configuration.max_number_of_distinct_countries_in_round }}</strong></div>
            </li>
            <li>
                <div class="label">Max cycle length</div>
                <div class="value"><strong>{{ configuration.max_cycle_length }}</strong></div>
            </li>
            <li>
                <div class="label">Max sequence length</div>
                <div class="value"><strong>{{ configuration.max_sequence_length }}</strong></div>
            </li>
            <li>
                <div class="label">Compatible blood group bonus</div>
                <div class="value"><strong>{{ configuration.blood_group_compatibility_bonus }}</strong></div>
            </li>
            <li>
                <div class="label">Forbidden country combinations</div>
                <div class="value">
                    <strong>{{ configuration.forbidden_country_combinations|map('country_combination_filter')|join(', ')
                        }}</strong>
                </div>
            </li>
            <li>
                <div class="label">Manual donor recipient scores</div>
                <div class="value">
                    <strong>{{
                        manual_donor_recipient_scores_with_medical_ids|map('donor_recipient_score_filter')|join(', ')
                        }}</strong>
                </div>
            </li>
            <li>
                <div class="label">Required patient ids</div>
                <div class="value"><strong>{{ required_patients_medical_ids|join(', ') }}</strong></div>
            </li>
        </ul>
    </div>
</div>
<div class="box">
    <h1 class="mb-0">Matchings ({{ matchings | length }})</h1>
</div>

{% for matching in matchings %}
<div class="box pt-0">
    <div class="matching-header">
        <h2>Matching #{{ matching.order_id }}</h2>

        <!-- Matching info -->
        <ul class="matching-info">
            <li>Score: <strong class="color-primary">{{ matching.score }}</strong></li>
            <li>Rounds: <strong>{{ matching.rounds|length }}</strong></li>
            <li>Transplants: <strong>{{ matching.count_of_transplants }}</strong></li>
            <li>Countries: <strong>{{ matching.countries|code_from_country_filter|join(', ') }}</strong></li>
        </ul>
    </div>

    <!-- Matching rounds -->
    {% for round in matching.rounds %}
    <div class="matching-round">
        {% set round_index = loop.index %}

        <!-- Matching round transplants -->
        {% for transplant in round.transplants %}
        <div class="matching-transplant">
            <!-- Prevent page break between round heading and first transplant -->
            {% if loop.index == 1 %}
            <h3>Round #{{ round_index }}</h3>
            {% endif %}

            <div class="transplant-header">
                <h4>Transplant #{{ loop.index }}</h4>
                <div class="score">Score: <span>{{ transplant.score }}</span></div>
            </div>

            <div class="transplant-content">
                <table>
                    <tbody>
                    <tr>
                        <td></td>
                        <td>
                            <div class="center-holder">
                                <div class="patient">
                                    <div class="flag">
                                        <img src="assets/countries/{{ transplant.donor.parameters.country_code.name }}.png"/>
                                    </div>
                                    {{ transplant.donor.medical_id }}
                                </div>
                            </div>
                        </td>
                        <td colspan="2">
                            <div class="center-holder">
                                <div class="patient">
                                    <div class="flag">
                                        <img src="assets/countries/{{ transplant.recipient.parameters.country_code.name }}.png"/>
                                    </div>
                                    {{ transplant.recipient.medical_id }}
                                </div>
                            </div>
                        </td>
                        <td>Score</td>
                    </tr>
                    <tr>
                        <td>Blood type</td>
                        <td>
                            <div class="code {% if transplant.compatible_blood %}matching{% endif %}">
                                {{ transplant.donor.parameters.blood_group }}
                            </div>
                        </td>
                        <td colspan="2">
                            <div class="code {% if transplant.compatible_blood %}matching{% endif %}">
                                {{ transplant.recipient.parameters.blood_group }}
                            </div>
                            <div class="small">
                                Acceptable:
                                {% for code in transplant.recipient.acceptable_blood_groups %}
                                <div class="code">{{ code }}</div>
                                {% endfor %}
                            </div>
                        </td>
                        <td>-</td>
                    </tr>
                    <tr class="anti-header">
                        <td></td>
                        <td>Antigens</td>
                        <td>Antigens</td>
                        <td>Antibodies</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>A</td>
                        <td>
                            {% for code in transplant.donor.parameters.hla_typing.codes_per_group|hla_code_a_filter %}
                            <div class="code {{ donor_antigen_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for code in transplant.recipient.parameters.hla_typing.codes_per_group|hla_code_a_filter
                            %}
                            <div class="code {{ recipient_antigen_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for code in transplant.recipient.hla_antibodies.hla_codes_over_cutoff_per_group|hla_code_a_filter %}
                            <div class="code {{ recipient_antibody_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>{{ transplant|compatibility_index_a_filter }}</td>
                    </tr>
                    <tr>
                        <td>B</td>
                        <td>
                            {% for code in transplant.donor.parameters.hla_typing.codes_per_group|hla_code_b_filter %}
                            <div class="code {{ donor_antigen_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for code in transplant.recipient.parameters.hla_typing.codes_per_group|hla_code_b_filter
                            %}
                            <div class="code {{ recipient_antigen_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for code in transplant.recipient.hla_antibodies.hla_codes_over_cutoff_per_group|hla_code_b_filter %}
                            <div class="code {{ recipient_antibody_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>{{ transplant|compatibility_index_b_filter }}</td>
                    </tr>
                    <tr>
                        <td>DR</td>
                        <td>
                            {% for code in transplant.donor.parameters.hla_typing.codes_per_group|hla_code_dr_filter %}
                            <div class="code {{ donor_antigen_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for code in
                            transplant.recipient.parameters.hla_typing.codes_per_group|hla_code_dr_filter %}
                            <div class="code {{ recipient_antigen_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for code in transplant.recipient.hla_antibodies.hla_codes_over_cutoff_per_group|hla_code_dr_filter %}
                            <div class="code {{ recipient_antibody_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>{{ transplant|compatibility_index_dr_filter }}</td>
                    </tr>
                    <tr>
                        <td>Other</td>
                        <td>
                            {% for code in transplant.donor.parameters.hla_typing.codes_per_group|hla_code_other_filter
                            %}
                            <div class="code {{ donor_antigen_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for code in
                            transplant.recipient.parameters.hla_typing.codes_per_group|hla_code_other_filter %}
                            <div class="code {{ recipient_antigen_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for code in transplant.recipient.hla_antibodies.hla_codes_over_cutoff_per_group|hla_code_other_filter %}
                            <div class="code {{ recipient_antibody_class(code, transplant) }}">{{ code }}</div>
                            {% endfor %}
                        </td>
                        <td>-</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>
{% endfor %}
</body>
</html>
