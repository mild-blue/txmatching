<app-header [user]="user"
            [downloadMatchingStatus]="downloadMatchingStatus"
            [downloadPatientsStatus]="downloadPatientsStatus"
            (downloadMatchingAction)="downloadMatchingPdfReport()"
            (downloadPatientsAction)="downloadPatientsXlsxReport()"
            [txmEvents]="txmEvents"
            [defaultTxmEvent]="defaultTxmEvent"
            (defaultTxmEventSelected)="setDefaultTxmEvent($event)"
            [loading]="loading"></app-header>

<section class="home">
  <app-container>
    <div class="home-header">
      <h1>
        Top Matchings
        <app-count *ngIf="!loading"
                   [count]="matchings.length"
                   [maxCount]="foundMatchingsCount"
                   title="Top matchings / Total number of matchings">
        </app-count>
      </h1>
      <div class="buttons">

        <app-button (click)="setConfigAsDefault()"
                    *ngIf="showConfiguration"
                    variant="success" size="sm"
                    [disabled]="isCurrentConfigDefault"
                    [title]="getTitleOfDefaultConfigButton"
        >
          <ng-container *ngIf="isCurrentConfigDefault">
            default configuration
            <mat-icon>done</mat-icon>
          </ng-container>

          <ng-container *ngIf="!isCurrentConfigDefault">
            set configuration as default
          </ng-container>
        </app-button>

        <button (click)="toggleConfiguration()"
                *ngIf="showConfiguration"
                class="config">
          Configure
          <fa-icon [icon]="configIcon"></fa-icon>
        </button>

      </div>
    </div>
  </app-container>

  <app-template-popup [isOpened]="configOpened"
                      [title]="'Configuration'"
                      (wasClosed)="toggleConfiguration()">
    <app-configuration *ngIf="configuration"
                       [configuration]="configuration"
                       [patients]="patients"
                       (configSubmitted)="calculate($event)"></app-configuration>
  </app-template-popup>

  <app-content>
    <h3 *ngIf="!loading && matchings.length === 0">No matchings were found.<br>Try to change settings and recalculate.</h3>
    <!--    <app-item-list *ngIf="!loading && matchings.length"-->
    <!--                   [items]="matchings"-->
    <!--                   [configuration]="configuration"-->
    <!--                   [patients]="patients"-->
    <!--                   [defaultTxmEvent]="defaultTxmEvent"></app-item-list>-->

    <div *ngIf="!loading && matchings.length" class="item-list">
      <div class="list">
        <ng-container *ngIf="useInfiniteScroll then listInfinite; else listDefault"></ng-container>
      </div>
      <div class="detail">
        <div [class.aligned-bottom]="activeAlignedBottom"
             [class.aligned-top]="activeAlignedTop"
             [class]="scrollableDetailClass"
             #detail
             cdk-scrollable>
          <app-matching-detail [item]="activeItem"
                               [configuration]="configuration"
                               [patients]="patients"></app-matching-detail>
        </div>
      </div>
    </div>
  </app-content>

</section>

<app-alert></app-alert>
<app-loading [show]="loading"></app-loading>

<ng-template #listInfinite>
  <div #list
       infinite-scroll
       class="list-inner"
       (scrolled)="onScrollDown()"
       [scrollWindow]="false">
    <ng-container [ngTemplateOutlet]="itemList"></ng-container>
  </div>
</ng-template>

<ng-template #listDefault>
  <div #list class="list-inner" [class.smooth-scroll]="enableSmoothScroll">
    <ng-container [ngTemplateOutlet]="itemList"></ng-container>
  </div>
</ng-template>

<ng-template #itemList>
  <app-new-item *ngFor="let item of displayedItems; trackBy: trackListItem"
                [item]="item"
                (click)="handleItemClick(item)"
                [isActive]="item === activeItem">
    <app-matching-item [item]="item"
                       [isActive]="item === activeItem"
                       [configuration]="configuration"
                       [patients]="patients"></app-matching-item>
  </app-new-item>
</ng-template>
