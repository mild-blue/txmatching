{% from 'hla_macro.html' import render_hla %}

{% macro render_transplant(donor, recipient, score_dict, matching_index, pair_index, compatible_blood_dict) %}
{% set score = score_dict[(donor.db_id, recipient.db_id)] %}
{% set donor_blood_is_acceptable = donor.parameters.blood_group in recipient.parameters.acceptable_blood_groups %}
{% set donor_blood_is_compatible = compatible_blood_dict[(donor.db_id, recipient.db_id)] %}
{% set matching_blood_group = donor.parameters.blood_group if donor_blood_is_acceptable else None %}
{% set matching_antigens = donor.parameters.hla_antigens.codes | intersect(recipient.parameters.hla_antigens.codes) %}
{% set scoreA = (matching_antigens | filtered_count_by_prefix("A")) * 1 %}
{% set scoreB = (matching_antigens | filtered_count_by_prefix("B")) * 3 %}
{% set scoreDR = (matching_antigens | filtered_count_by_prefix("DR")) * 9 %}

<div class="transplant">
    <div class="transplant-header">
        <div class="pair">
            <img src="static/img/countries/{{donor.parameters.country_code}}.png" style="margin-right: 5px" class="flag"/>
            {{ donor.medical_id }} <span class="arrow-right"></span> {{ recipient.medical_id }}
            <img src="static/img/countries/{{recipient.parameters.country_code}}.png" style="margin-left: 5px" class="flag"/>
        </div>

        <div class="score">
            Score: <span>{{ score }}</span>
        </div>
    </div>

    <div class="transplant-content">

        <table>
            <tbody>
            <tr>
                <td></td>
                <td>
                    <img src="static/img/countries/{{donor.parameters.country_code}}.png" class="flag"/>
                    {{ donor.medical_id }}
                </td>
                <td colspan="2">
                    <img src="static/img/countries/{{recipient.parameters.country_code}}.png" class="flag"/>
                    {{ recipient.medical_id }}
                </td>
                <td>Score</td>
            </tr>
            <tr>
                <td>Blood type</td>
                <td>
                    {% set bloodClass = "matching-blood-group" if donor_blood_is_compatible else "" %}
                    <span class="inline_code {{ bloodClass }}">{{ donor.parameters.blood_group }}</span>
                </td>
                <td colspan="2">
                    {% set bloodClass = "matching-blood-group" if donor_blood_is_compatible else "" %}
                    <span class="inline_code {{ bloodClass }}">{{ recipient.parameters.blood_group }}</span>
                    <div class="small">
                        Acceptable:
                        {% for blood_group in recipient.parameters.acceptable_blood_groups %}
                        <span class="inline_code">{{ blood_group }}</span>
                        {% endfor %}
                    </div>
                </td>
                <td>
                    -
                </td>
            </tr>
            <tr class="anti-header">
                <td></td>
                <td>Antigens</td>
                <td>Antigens</td>
                <td>Antibodies</td>
                <td></td>
            </tr>
            <tr>
                <td>A</td>
                {{ render_hla(donor, "A", matching_antigens, true) }}
                {{ render_hla(recipient, "A", matching_antigens, true) }}
                <td>{{ scoreA }}</td>
            </tr>
            <tr>
                <td>B</td>
                {{ render_hla(donor, "B", matching_antigens, true) }}
                {{ render_hla(recipient, "B", matching_antigens, true) }}
                <td>{{ scoreB }}</td>
            </tr>
            <tr>
                <td>DR</td>
                {{ render_hla(donor, "DR", matching_antigens, true) }}
                {{ render_hla(recipient, "DR", matching_antigens, true) }}
                <td>{{ scoreDR }}</td>
            </tr>
            <tr class="footer-score">
                <td colspan="4">
                    Final score:
                </td>
                <td><span>{{ score }}</span></td>
            </tr>
            </tbody>
        </table>

    </div>
</div>
{% endmacro %}

